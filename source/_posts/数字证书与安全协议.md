---

title: 数字证书与安全协议

date: 2022-01-23 01:07

tags: 
- 数字证书 
- 密码学

categories: 密码学

---

## 数字证书
### 什么是是数字证书
#### 数字身份
数字身份的本质是一对秘钥，分别为公钥和私钥。

把数字身份比喻成一个证件，那么数字证书就是“身份认证机构”盖在证件上的一个章（即权威机构的背书）。没有背书的数字身份是没实际意义的。

### 实际应用
#### 生活中
一切进行数据通信的地方都有可能会用到数字证书，如
- 电子邮件
- 浏览网页
- 手机APP
- 科学上网

#### 开发中
- 工具抓包：fiddler

### 为什么要有数字证书
#### 演进过程
下面展示了网络安全通信是如何逐步衍生出数字证书的。

![](/images/演进过程1.gif)

第一阶段，双方协商好对称密钥，之后的通信都使用对称密钥对明文进行加密解密操作。但是这个阶段的缺点是双方需要提前约定好密钥，该模式无法满足临时与陌生对象通信的需求。

![](/images/演进过程2.gif)
第二阶段，双方使用非对称秘钥通信，其中bob有一对公私钥，通信初始他会把公钥提供给alice，alice使用该公钥来加密明文。由于密文只有bob的私钥能解密，所以在通信过程中其他人是无法解开密文的（未被篡改的情况下）。
该阶段的主要问题在于非对称加密明文的性能相较对称加密性能要差很多。

![](/images/演进过程3.gif)
第三阶段，alice使用了临时生成的**对称密钥**来加密明文，然后再用bob的公钥加密**对称密钥**，然后把**被加密的明文**和**被加密的密钥**发送给bob，由于**被加密的密钥**只能用bob的私钥解密，所以过程是安全的（未被篡改的情况下），同时**对称密钥**加密明文保证了性能。但这个过程真的没缺陷了吗？我们看看以下场景：
![](/images/演进过程3-缺陷.gif)
该过程中，中间人可以拦截bob发给alice的公钥，同时发送自己的公钥给alice，伪装成bob。之后的通信过程中，alice使用伪装的公钥加密出的密文，自然能被中间人破解。更有甚者中间人可以伪造一份欺骗性的报文发给bob。该过程省略了alice用自己私钥加签的过程，本质上一样是不安全的，中间人既然能伪造bob给alice的公钥，当然也能伪造alice给bob的公钥，那么这个过程中的签名自然也是可以伪造的。
![](/images/演进过程4.gif)
上一阶段的核心问题在于bob的公钥在传输过程中被篡改了，对于alice来说bob的公钥是不可信的。那么解决了公钥的信任问题，这个过程就安全了。

第四阶段：这一阶段bob把自己的公钥封装到数字证书里。在之后的通信初始阶段bob会先把数字证书发给alice，alice去CA机构验证数字证书的合法性，若验证通过，则代表bob的数字证书是可信的，那么证书里面的公钥自然也是可信的。这样就顺利的解决了公钥的信任问题。


### 为什么数字证书的认证过程是可信的
![](/images/证书认证可信.gif)
在服务域名上线之前，会先用自己的公钥生成一份证书签名请求文件（certificate sign request，csr），可以理解为填了份带有公钥的申请表单，发给CA机构，然后CA机构会把这份表单里面的关键信息（包括公钥、服务域名、所属机构等）提取成摘要，用自己的私钥进行加签。然后把签名和关键信息，输出到正式的数据结构中，形成了数字证书，再把这个数字证书发送给服务方，这个过程就叫做证书的签发。

服务器得到了具有公证力的证书，上线新的域名。随后客户端就可以访问该域名对服务器发起握手，握手阶段服务器会把证书发给客户端，客户端在证书里找到它的签发机构，遂去获取签发机构的证书。此时我们注意服务器证书的签名是用CA机构的私钥加签的，理所当然可以用CA机构的公钥进行验签。如果验签成功，则说明了服务器的证书是可信的。

可是此时出现了新的问题，我们通过这个流程可以验证服务器证书的有效性，前提是CA机构的证书也是合法的，但如何保证CA证书不会被篡改呢？

同理我们的客户端可以走相同的流程，去获取CA机构的上级机构的证书，来验证CA证书的有效性，这样就形成了一个递归验证链。这个递归链是有边界的，它的边界就是**根证书。**

![](/images/Pasted%20image%2020220123125102.png)


由上图的信任链我们可以看出验证操作会一直递归到根证书。这里的关键就在于根证书是内置于我们操作系统本地的，那么在获取根证书的时候就不想要经过网络。若不经过网络，则就不存在被中间人攻击的风险。所以，到根证书为止，就可以证明整个信任链是可信的了。

#### 小结
加密技术的存在是为了保障通信信息不被第三方窃取，保证信息的安全性，该技术甚至可以追溯到3900年前的古希腊。但是随着互联网尤其是无线网络的发展，出现了一种新的场景，就是通信双方节点，通常都是需要临时交换密钥来进行安全通信。伴随着这种场景，新的攻击手段也应运而生，那就是中间人攻击，简单来说就是中间人可以伪装成你的通信对象，交换非法秘钥，以达到监听窃取、篡改信息的目的。

而**数字证书**就是为了解决**信任危机**而的产生。
目前大部分数字证书都采用 x509第三版数据结构
数字证书是实现**安全协议**过程的基石。

## 安全协议
### TLS
#### TLS属于哪层协议？
TLS所处的协议层如下：
数据帧{ IP层{ TCP层{ **TLS层{** 应用层{} **}** } } }

可见TLS介于传输层（TCP）和应用层之间。

如果把网络协议想象成一个纸团，协议之间的嵌套就像一张纸包住另一个纸团一样。最里面的一层就是应用层协议，如HTTP。而网络报文的传输过程中，任何人能够截获这个纸团，并层层剥开，但是如果没有相应的秘钥，是没法剥开TLS这一层的，也就没法看到里面的HTTP报文。
![](/images/Pasted%20image%2020220123093321.png)

#### SSL和TLS的关系
SSL是网景制定的，TLS是IETF指定的。TLS1.0建立在SSL3.0基础之上，可以理解为SSL3.1。由于习惯原因，现在很多对安全层依旧沿用SSL的称呼，但实际上已经使用的是TLS的技术了。

网景是一家传说级的公司，Mozilla（火狐前身）和JavaScript都诞生于这家公司。
而IETF是一个开放的标准组织，网络上随处可见的RFC标准就是出自他们。

![](/images/Pasted%20image%2020220123093824.png)


#### TLS 的运作过程
![](/images/Pasted%20image%2020220123121739.png)

#### TLS的关键阶段
握手阶段是TLS的关键
握手过程，主要就是双方交换公共参数，生成对称密钥，用于加密通信
秘钥交换算法（key exchange）：
- RSA based key exchange
- DH(Diffie-Hellman) based key exchange

#### 交换秘钥过程
HTTPS常用的密钥交换算法有两种，分别是`RSA`和`ECDHE`
由于RSA不具备向前安全性质，现在大部分服务器不会使用它来交换秘钥
每个通信过程的秘钥没有关系，相互独立，才能保证 **「前向安全」**。
`DH`作为`ECDHE`的基础，详细介绍参考[DH]一节
`ECDHE`的演进路线基本是这样的：`DH`-> `DHE`->`ECDHE`，

#### 向前安全性
**前向安全性**或**前向**保密**性**（英语：Forward Secrecy，缩写：FS），有时也被称为完美**前向安全**（英语：Perfect Forward Secrecy，缩写：PFS），**是**密码学中通讯协议的**安全**属性，指的**是**长期使用的主密钥泄漏不会导致过去的会话密钥泄漏。

#### 演进过程
以下过程基于网络交换秘钥场景

|技术|性能|防监听（未篡改）|防篡改|向前安全
-|-|-|-|-
对称加密{原文}|√|x|x|x
非对称加密{原文}|x|√|x|x
非对称{密钥}|√|√|x|x
非对称{密钥}+公钥背书|√|√|√|x
非对称{临时DH公钥}+公钥背书|√|√|√|√

### 两种密钥交换模式
#### RSA Base
流程
从浏览器请求HTTPS，到渲染数据的整个过程
- Client Hello
 - 随机数、算法套件
- Server Hello
 - 随机数、选定算法、公钥
- Certificate
 - 验证身份的项目：
 - 涉及证书链的有效期
 - 涉及证书链的签名

 举例子，证书验证不通过的情况
 ![](/images/Pasted%20image%2020220123121951.png)
- Server Hello Done
- Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message
- 服务端 Change Cipher Spec, Encrypted Handshake Message
- 加密通信

premaster key、masterKey的作用
![](/images/Pasted%20image%2020220123122022.png)

#### DH Base
##### DH算法
DH算法的原理可以参考这一篇文章：[为了搞懂 HTTPS，我把大学的数学书拿了出来。。。)](https://bbs.huaweicloud.com/blogs/detail/273779)


##### 小结
要注意dh算法本身并不能防范中间人攻击，中间人可以通过分别对双方进行DH密钥交换进行攻击，所以DH实际需要配合身份认证机制才能安全工作。DH两种工作方式：
1. Fixed Diffie-Hellman：直接把DH公钥固化到服务方证书里，和RSA一样不具备向前安全性
2. Ephemeral Diffie-Hellman (简称为DHE)：服务方使用动态DH公钥，只是会对公钥进行签名

在DH模式中，数字证书，不是用于生成通信用的秘钥，而是单纯用于双方认证身份（这个是大部分人很容易理解错的地方）

### 实践
相关配置
- internet属性
如何查看一个网站使用的TLS版本：f12->security
![](/images/Pasted%20image%2020220123122235.png)


#### 证书的生命周期管理
流行的证书生命周期管理工具有两种，一个是jdk自带的keytool；一个是开源项目openSSL

|生命周期|keytool相关命令|openssl相关命令|
|-|-|-|
|创建密钥对| -genkeypair| genrsa|
|创建签名请求| -certreq|req|
|签发证书| -gencert| x509|
|秘钥库管理| -importcert、-list| pkcs12 |
|使用证书|||
|销毁证书|||


#### 验证der编码和base64编码的区别
der编码           base64编码
直接导出证书  导出证书 -rfc
windows下可以点击证书复制到文件
相互转换：notepad++转base64

#### Nginx引入、使用证书
Nginx发布https服务，需要准备两个文件：一个是pem，证书文件，代表了服务公钥；一个是key，密钥文件，代表了服务私钥；

pem可以直接使用base64编码的证书文件；
key则需要用openssl命令来从秘钥库导出；
`openssl pkcs12 -nodes -nocerts -in -out`

#### 待办
- 什么时候会进行数字证书认证
- keytool -gencert -sigalg 有什么用

### 拓展
#### 如何理解证书链
#### RSA vs DSA
这两个算法都是对称密钥算法，其中
- 名称问题
 RSA三位发明者的名字的缩写
 DSA则是 Digital Signature Algorithm 的缩写
- 数学基础
 - RSA基于大数分解（两个素数的乘积）
 - DSA基于离散对数难题

#### 数字证书的数据结构
CN(Common Name名字与姓氏)
OU(Organization Unit组织单位名称)
O(Organization组织名称)
L(Locality城市或区域名称)
ST(State州或省份名称)
C(Country国家名称）

![](/images/Pasted%20image%2020220123125851.png)
详细参考： https://www.cem.me/20150209-cert-binaries-4.html


#### 秘钥、与ssh打通
#### 域名及CName AAA、AAAA
#### PGP和GPG加签模式的区别

### 参考文献：

> [序号]主要责任者.电子文献题名[电子文献及载体类型标识].电子文献的出版或获得地址,发表更新日期/引用日期.

> 例如：[12]王明亮.关于中国学术期刊标准化数据库系统工程的进展[EB/OL].1998-08-16/1998-10-01.

> [8]万锦.中国大学学报文摘(1983-1993).英文版[DB/CD].北京:[中国大百科全书出版社](https://baike.baidu.com/item/%E4%B8%AD%E5%9B%BD%E5%A4%A7%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6%E5%87%BA%E7%89%88%E7%A4%BE/2267934),1996.

- [1]梁栋.java加密与解密的艺术（第二版）

- [2]2018-2019年中国网络可信身份服务发展蓝皮书

- [3]贾铁军.网络安全技术与应用（第三版）

- [4]王绍斌.云计算安全事件：从入门到精通

- [5]韩立刚.深入浅出计算机网络

- [6]汪德嘉.身份危机

- [数字身份 - 维基百科，自由的百科全书 (wikipedia.org)](https://zh.wikipedia.org/wiki/%E6%95%B0%E5%AD%97%E8%BA%AB%E4%BB%BD)

- [TLS协议分析（密码学101以及TLS协议简介） · kaspterio (kapsterio.github.io)](http://kapsterio.github.io/test/2021/09/17/TLS.html)

- [SSL/TSL | Echo Blog (houbb.github.io)](https://houbb.github.io/2018/09/26/SSL-TLS)

- [Https SSL/TLS PreMaster/Master Secret(Key)计算_服务器应用_Linux公社-Linux系统门户网站 (linuxidc.com)](https://www.linuxidc.com/Linux/2015-07/120230.htm)

- [dev.to](https://dev.to/wayofthepie/structure-of-an-SSL-x-509-certificate-16b)

- [为了搞懂 HTTPS，我把大学的数学书拿了出来。。。-云社区-华为云 (huaweicloud.com)](https://bbs.huaweicloud.com/blogs/detail/273779)

- [DSA与RSA——DSA 只能用于数字签名，而无法用于加密（某些扩展可以支持加密）；RSA 即可作为数字签名，也可以作为加密算法。在业界支持方面，RSA 具有更为广泛的部署与支持。 - bonelee - 博客园 (cnblogs.com)](https://www.cnblogs.com/bonelee/p/12931388.html)

- [数字证书应用综合揭秘（包括证书生成、加密、解密、签名、验签） - 风尘浪子 - 博客园 (cnblogs.com)](https://www.cnblogs.com/leslies2/p/7442956.html)

- https://juejin.cn/post/6930446060846481416

- [手撕非对称密码原理（一） - 欧锻灏的博客 (huawei.com)](http://3ms.huawei.com/km/blogs/details/10441927?comment=17411983)